# 工具设计最佳实践

本文档提供了为智能体系统设计工具的额外最佳实践和指南。

## 工具哲学

工具是智能体与世界之间的主要接口。与为理解底层系统的开发人员设计的传统 API 不同，工具必须为语言模型设计，因为这些模型通过描述推断意图，并根据自然语言请求生成调用。这种根本差异要求我们重新思考如何设计和记录工具接口。

目标是创建可被智能体发现、理解并正确使用的工具，而无需大量的尝试和错误。工具定义中的每一个歧义都是一个潜在的失败点。每一个不清晰的参数名称都会迫使智能体去猜测。每一个缺失的示例都会让智能体在面对边界情况时失去引导。

## 描述工程原则

### 原则 1：回答基本问题

每个工具描述都应清晰地回答四个问题。**工具做什么？** 使用具体术语准确陈述工具实现的功能，避免使用“有助于”或“可用于”等模糊语言。**什么时候该使用它？** 提供具体的触发条件和上下文，包括直接触发信号和指示工具适用性的间接信号。**它接受什么输入？** 记录参数及其类型、约束和默认值，解释每个参数控制的内容。**它返回什么？** 描述返回格式和结构，包括成功响应和错误条件的示例。

### 原则 2：使用一致的结构

在代码库的所有工具描述中保持一致的结构。当智能体遇到一个新工具时，它应该能够根据从其他工具中学到的模式预测在哪里可以找到特定信息。这减少了认知负荷，并防止了由格式不一致引起的错误。

推荐的结构包括：第一句简要描述，带有使用上下文的详细解释，具有清晰类型信息的参数部分，描述输出结构的返回部分，以及列出可能失败模式和恢复指南的错误部分。

### 原则 3：包含具体示例

示例填补了抽象描述与实际使用之间的鸿沟。包含展示常见参数组合的典型调用示例、边界情况及其处理方法的示例，以及错误响应和适当恢复操作的示例。

好的示例是具体的而非通用的。不要用“使用像 '123' 这样的 ID”，而要用“使用格式：'CUST-######'（例如 'CUST-000001'）”。不要用“提供日期”，而要用“格式：'YYYY-MM-DD'（例如 '2024-01-15'）”。

## 命名约定

### 参数命名

参数名称应该是自解释的。使用能清晰指示用途且无需额外解释的名称。除了“id”或“url”等广泛理解的缩写外，优先使用完整单词。在不同工具中对相似概念使用一致的命名。

好的参数名称包括 customer_id、search_query、output_format、max_results 和 include_details。糟糕的参数名称包括 x、val、param1 和 info。

### 枚举值

当参数接受枚举值时，在所有工具中使用一致的命名。对于布尔类型的选项，使用前缀模式：肯定选项使用“include_”（include_history, include_metadata），否定选项使用“exclude_”（exclude_archived, exclude_inactive）。对于类别值，使用一致的术语，例如“format”: "concise" | "detailed"，而不是在某些工具中使用 "short" | "long"，而在另一些工具中使用 "brief" | "complete"。

## 错误消息设计

### 双重受众

错误消息服务于两类需求不同的受众。调试问题的开发人员需要详细的技术信息，包括堆栈跟踪和内部状态。从失败中恢复的智能体需要可操作的指南，告诉它们出了什么问题以及如何纠正。

设计错误消息时，应将智能体的恢复作为首要考虑因素。使用清晰的语言说明具体出了什么问题。提供描述智能体下一步该做什么的解决指南。为输入错误提供纠正后的格式。添加有效输入的示例。

### 错误消息结构

```json
{
    "error": {
        "code": "INVALID_CUSTOMER_ID",
        "category": "validation",
        "message": "客户 ID 'CUST-123' 不符合所需格式",
        "expected_format": {
            "description": "客户 ID 必须为 9 位字符",
            "pattern": "CUST-######",
            "example": "CUST-000001"
        },
        "resolution": "请提供符合 CUST-###### 模式的客户 ID",
        "retryable": true
    }
}
```

### 常见错误模式

验证错误应指定接收到的内容、期望的格式以及如何纠正。速率限制错误应指定等待时间和重试指南。未找到错误应建议替代方法或验证步骤。系统错误应指示重试是否合适并建议替代方案。

## 响应格式优化

### Token 与准确性的权衡

详尽的响应提供全面的信息，但会消耗大量上下文 Token。简练的响应最小化 Token 使用，但可能缺乏必要的细节。最佳方法是提供格式选项，允许智能体根据其需求请求适当的详细程度。

### 格式选项模式

```python
def get_customer_response(format: str = "concise"):
    """
    检索客户信息。
    
    参数:
        format: 响应格式 - 'concise' 仅返回关键字段，
                'detailed' 返回完整的客户记录
    """
    if format == "concise":
        return {
            "id": customer.id,
            "name": customer.name,
            "status": customer.status
        }
    else:  # detailed
        return {
            "id": customer.id,
            "name": customer.name,
            "email": customer.email,
            "phone": customer.phone,
            "address": customer.address,
            "status": customer.status,
            "created_at": customer.created_at,
            "history": customer.history,
            "preferences": customer.preferences
        }
```

### 何时使用每种格式

在进行快速验证或简单查找、仅需要确认时，以及在初始检索后的后续工具调用中，使用 concise（简练）格式。在根据客户数据做出决策、输出将作为其他处理的输入，以及为了保证正确性必须有完整上下文时，使用 detailed（详细）格式。

## 工具集设计

### 管理工具泛滥

随着智能体系统的增长，工具集往往会不断增加。更多的工具可以实现更多的功能，但会带来选择挑战。研究表明，工具描述的重叠会导致模型混淆。关键在于：如果人类工程师无法确定在给定情况下应使用哪个工具，就不能指望智能体做得更好。

### 合并指南

将代表单一工作流中连续步骤的工具合并为一个处理整个工作流的工具。例如，不要使用 list_users、list_events 和 create_event，而是实现一个 schedule_event 工具，通过一次调用即可查找可用性并进行预订。

即使具有某些共同功能，也要保持具有根本不同行为的工具相互独立。在不同上下文中使用的工具应保持分离以防止混淆。

即使工具在相似领域运行，也要保持清晰的边界。通过精心设计尽量减少功能重叠。

### 工具选择引导

在设计工具集时，考虑智能体做出正确选择所需的信息。如果多个工具可能适用于某种情况，请在描述中澄清区别。使用命名空间（namespacing）创建逻辑分组，帮助智能体导航工具空间。

## 测试工具设计

### 评估标准

根据清晰度、完整性、可恢复性、效率和一致性标准评估工具设计。**清晰度**衡量智能体是否能确定何时使用该工具。**完整性**衡量描述是否包含了所有必要信息。**可恢复性**衡量智能体是否能从错误中恢复。**效率**衡量工具是否支持适当的响应格式。**一致性**衡量工具是否遵循命名和模式约定。

### 智能体测试模式

通过呈现具有代表性的智能体请求并评估生成的工具调用来测试工具：

1. 准备包含多样化智能体请求的测试用例
2. 让智能体为每个请求制定工具调用
3. 根据预期模式评估调用的正确性
4. 识别常见的失败模式
5. 根据发现结果完善工具定义

## 应避免的反模式

### 模糊的描述

糟糕： “在数据库中搜索客户信息。” 这留下了太多未回答的问题。哪个数据库？有哪些信息可用？查询应采用什么格式？

优秀： “通过 ID 或电子邮件检索客户信息。当用户询问特定客户详情、历史或状态时使用。返回包含 id、name、email、account_status 和可选订单历史的客户对象。”

### 隐晦的参数名

糟糕： 命名为 x、val 或 param1 的参数会迫使智能体猜测其含义。

优秀： 命名为 customer_id、max_results 或 include_history 的参数是自解释的。

### 缺失错误处理

糟糕： 工具由于通用错误而失败，或完全没有错误处理。

优秀： 工具提供特定的错误类型、消息和解决指南。

### 命名不一致

糟糕： 在一些工具中使用 id，在另一些工具中使用 identifier；对于相似概念，在某些地方用 customer_id，另一些地方用 user_id。

优秀： 在所有工具中对相似概念保持一致的命名模式。

## 工具设计自检表

在部署新工具之前，请验证：
- [ ] 描述是否清晰说明了工具的功能及使用时机。
- [ ] 所有参数是否都有描述性名称和清晰的类型信息。
- [ ] 返回值是否记录了结构和示例。
- [ ] 错误情况是否包含可操作的消息。
- [ ] 工具是否遵循了其他地方使用的命名约定。
- [ ] 示例是否展示了常见的使用模式。
- [ ] 如果响应大小差异很大，是否提供了格式选项。
