---
name: context-fundamentals
description: 当用户要求“了解上下文”、“解释上下文窗口”、“设计助手架构”、“调试上下文问题”、“优化上下文使用”，或讨论上下文组件、注意力机制、渐进式披露或上下文预算时，应使用此技巧。提供 AI 助手系统的上下文工程基础知识。
---

# 上下文工程基础 (Context Engineering Fundamentals)

上下文（Context）是语言模型在推理时可用的完整状态。它包括模型在生成响应时可以处理的所有内容：系统指令、工具定义、检索到的文档、消息历史记录和工具输出。理解上下文基础是进行有效上下文工程的前提。

## 何时激活

在以下情况下启用此技能：
- 设计新的助手系统或修改现有架构
- 调试可能与上下文相关的意外助手行为
- 优化上下文使用以降低 token 成本或提高性能
- 向新团队成员介绍上下文工程概念
- 评审与上下文相关的设计决策

## 核心概念

上下文由几个不同的组件组成，每个组件具有不同的特征和约束。注意力机制（Attention mechanism）创建了一个制约有效上下文使用的有限预算。渐进式披露（Progressive disclosure）通过仅在需要时加载信息来管理这一限制。工程学科的目标是策划出能实现预期结果的最小高信号 token 集。

## 详细主题

### 上下文的构成 (The Anatomy of Context)

**系统提示词 (System Prompts)**
系统提示词确立了助手的核心身份、约束和行为指南。它们在会话开始时加载一次，通常贯穿整个对话。系统提示词应极其清晰，并使用简单、直接的语言，且处于适合助手的“高度”。

合适的高度平衡了两种失败模式。在一个极端，工程师硬编码复杂的脆弱逻辑，增加了维护负担；在另一个极端，工程师提供模糊的高层指导，未能为期望的输出提供具体信号，或错误地假设了共享上下文。最佳高度应达到平衡：既具体到能有效引导行为，又灵活到能提供强大的启发。

使用 XML 标签或 Markdown 标题将提示词组织成不同的部分，以划分背景信息、指令、工具指南和输出说明。

**工具定义 (Tool Definitions)**
工具定义指定了助手可以采取的操作。每个工具包括名称、描述、参数和返回格式。工具定义通常位于上下文的前端，紧随系统提示词之后。

工具描述共同引导助手的行为。平庸的描述迫使助手猜测；优化的描述包括使用背景、示例和默认值。整合原则指出，如果人类工程师无法明确说出在给定情况下应使用哪个工具，那么助手也不能被期望做得更好。

**检索到的文档 (Retrieved Documents)**
检索到的文档提供领域特定的知识、参考资料或与任务相关的信息。助手使用检索增强生成（RAG）在运行时将相关文档拉入上下文，而不是预先加载所有可能的信息。

即时（Just-in-time）方法维护轻量级的标识符（文件路径、存储的查询、网页链接），并使用这些引用动态加载数据。这模仿了人类认知：我们通常不背诵整个语料库，而是使用外部组织和索引系统按需检索信息。

**消息历史记录 (Message History)**
消息历史记录包含用户与助手之间的对话，包括之前的查询、回复和推理。对于长周期任务，消息历史记录可能会占据上下文的主导地位。

消息历史记录充当草稿本记忆，助手在其中跟踪进度、维护任务状态并保留跨轮次的推理。有效地管理消息历史记录对于完成长周期任务至关重要。

**工具输出 (Tool Outputs)**
工具输出是助手操作的结果：文件内容、搜索结果、命令执行输出、API 响应等。在典型的助手轨迹中，工具输出占据了大部分 token。研究表明，观察结果（工具输出）可能达到总上下文使用量的 83.9%。

无论工具输出是否与当前的决策相关，它们都会消耗上下文。这促使了观察掩码（Observation masking）、压缩（Compaction）和选择性工具结果保留等策略的产生。

### 上下文窗口与注意力机制

**注意力预算约束 (The Attention Budget Constraint)**
语言模型通过注意力机制处理 token，在上下文中的所有 token 之间建立配对关系。对于 n 个 token，这会产生必须计算和存储的 n² 个关系。随着上下文长度的增加，模型捕捉这些关系的能力会被摊薄。

模型从训练数据分布中发展出注意力模式，其中短序列占主导。这意味着模型对于全上下文范围内的依赖关系缺乏经验和专门的参数。结果就是存在一个随上下文增长而耗尽的“注意力预算”。

**位置编码与上下文扩展**
位置编码插值允许模型通过将长序列适配到最初训练的小上下文中来处理它们。然而，这种适配会引入对 token 位置理解的退化。模型在长上下文中仍保持高度能力，但与在短上下文中的表现相比，在信息检索和长程推理方面的精度会有所下降。

**渐进式披露原则 (The Progressive Disclosure Principle)**
渐进式披露通过仅在需要时加载信息来高效管理上下文。在启动时，助手仅加载技能名称和描述 —— 这足以让它知道某项技能何时相关。只有当技能为特定任务激活时，才会加载全部内容。

这种方法在保持助手响应速度的同时，使其能够按需访问更多上下文。

### 质量 vs 数量

关于“更大的上下文窗口能解决记忆问题”的假设已在经验上被证伪。上下文工程意味着寻找**最小的、高信号的 token 集**，以最大化实现预期结果的可能性。

指导原则是**信息量胜过详尽性**。包含对当前决策重要的内容，排除不重要的内容，并设计能够按需访问额外信息的系统。

## 实践指南

### 基于文件系统的访问
具有文件系统访问权限的助手可以自然地使用渐进式披露。将参考资料、文档和数据存储在外部。仅在使用标准文件系统操作时按需加载文件。

### 混合策略 (Hybrid Strategies)
最有效的助手采用混合策略。为了速度预加载部分上下文（如 `CLAUDE.md` 文件或项目规则），但允许在需要时自主探索额外的上下文。

### 上下文预算 (Context Budgeting)
在设计时考虑到明确的上下文预算。监控开发过程中的上下文使用情况。在适当的阈值处实现压缩触发器。设计系统时应假设上下文会退化，而不是寄希望于它不会退化。

## 示例

**示例 1：组织系统提示词**
```markdown
<BACKGROUND_INFORMATION>
你是一位帮助开发团队的 Python 专家。
当前项目：Python 3.9+ 的数据处理流水线。
</BACKGROUND_INFORMATION>

<INSTRUCTIONS>
- 编写简洁、地道的 Python 代码。
- 为函数签名包含类型注解。
- 为公共函数添加 Docstrings。
</INSTRUCTIONS>

<TOOL_GUIDANCE>
使用 bash 进行 Shell 操作，使用 python 处理代码任务。
</TOOL_GUIDANCE>

<OUTPUT_DESCRIPTION>
提供带有语法高亮的代码块。
</OUTPUT_DESCRIPTION>
```

## 准则

1. 将上下文视为边际收益递减的有限资源。
2. 将关键信息放在注意力偏好的位置（开头和结尾）。
3. 使用渐进式披露延迟加载直到需要时。
4. 使用清晰的边界组织系统提示词。
5. 在利用率达到 70-80% 时实施压缩触发器。
6. 宁要小而高信号的上下文，不要大而低信号的上下文。

## 技巧元数据

**创建日期**: 2025-12-20
**作者**: Agent Skills for Context Engineering 贡献者
**版本**: 1.0.0
