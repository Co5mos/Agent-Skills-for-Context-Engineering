# 示例：X-to-Book 多智能体系统

本示例展示了如何应用“上下文工程智能体技能”来设计一个生产级多智能体系统。该系统监控 X (Twitter) 账号，并根据其内容生成每日合成书籍。

## 问题描述

用户需要一个具备以下功能的多智能体系统：
- 每日监控目标 X 账号
- 从推文中提取见解和模式
- 生成结构化的书籍输出

这套系统极具挑战性，因为：
- **数据量巨大**（每天数百推文）
- **长文本输出**（需要保持连贯性）
- **时间感知**（追踪叙事如何演变）
- **质量要求高**（准确的归属引用，无幻觉）

## 技能应用

### 1. 多智能体模式 (multi-agent-patterns)

**决策**：选择了“主管/编排者模式”（Supervisor/Orchestrator）而非点对点 Swarm。

**技能推理**：
> “主管模式由一个核心智能体控制，向专家分发任务并综合结果。主管维护全局状态和轨迹，将用户目标分解为子任务，并路由给合适的执行者。”

**应用**：书籍制作有清晰的顺序阶段（抓取 → 分析 → 综合 → 撰写 → 编辑），受益于集中协调。各阶段间的质量关卡需要明确的检查点。

**针对的失败模式**：
> “主管瓶颈：主管会累积来自所有执行者的上下文，变得容易饱和并导致性能退化。”

**缓解措施**：原始推文数据从不进入编排者（Orchestrator）的上下文。抓取者写入文件系统，其他智能体从文件系统读取。编排者仅接收阶段性的摘要。

### 2. 上下文基础 (context-fundamentals)

**决策**：为每个智能体设定严格的上下文预算，并采用渐进式披露。

**技能推理**：
> “上下文必须被视为边际收益递减的有限资源。就像人类只有有限的工作记忆一样，语言模型在解析大量上下文时也有‘注意力预算’。”

**应用**：每个智能体都有明确的 Token 预算：
- 编排者：50k（仅用于路由）
- 抓取者：20k（一次处理一个账号）
- 撰写者：80k（一次处理一个章节）

**应用原则**：
> “渐进式披露通过仅在需要时加载信息来高效管理上下文。”

**应用**：首先加载书籍大纲（轻量级）。只有当撰写者处理特定章节时，才加载该章节的全部内容。

### 3. 记忆系统 (memory-systems)

**决策**：选择“时态知识图谱”而非简单的向量数据库。

**技能推理**：
> “向量数据库会丢失关系信息……且难以处理时间有效性。事实会随时间变化，但向量数据库没有机制来区分‘当前事实’和‘过时事实’。”

**应用**：系统需要回答如下查询：
- “账号 @account 在一月份对 AI 监管的立场是什么？”
- “哪些账号在加密货币问题上意见一致/不一致？”

这些需要关系遍历和时间有效性，向量数据库无法提供。

### 4. 上下文优化 (context-optimization)

**决策**：对推文数据采用“观察遮蔽”（Observation masking）。

**技能推理**：
> “在智能体轨迹中，工具输出可能占到 Token 使用量的 80% 以上。其中大部分是已经完成使命的冗长输出。”

**应用**：每日推文量可能达到 10w+ Token。处理流程为：
1. 抓取者处理
2. 写入文件系统（不通过上下文传递）
3. 分析者分块读取
4. 到达综合者之前完成摘要

### 5. 工具设计 (tool-design)

**决策**：采用 3 个整合工具，而非 15+ 个细碎工具。

**技能推理**：
> “合并原则指出，如果人类工程师无法确定在给定情况下应使用哪个工具，就不能指望智能体做得更好。”

**应用**：不使用单独的 `fetch_timeline`、`fetch_thread` 等，而是实现一个带 `action` 参数的 `x_data_tool`。

### 6. 评估 (evaluation)

**决策**：采用多维度评分表和自动化流水线。

**技能推理**：
> “智能体质量不是单一维度的。它包括事实准确性、完整性、连贯性、工具效率和过程质量。”

**应用**：设定 5 个加权维度：
- 来源准确性 (30%) - 引用与原始推文核实
- 主题连贯性 (25%) - 叙事流
- 完整性 (20%) - 主题覆盖率
- 见解质量 (15%) - 综合能力而非重复
- 可读性 (10%) - 文笔质量

---

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                     编排者智能体 (ORCHESTRATOR)                  │
│  上下文：50k tokens (仅用于路由、检查点，无原始数据)            │
│  模式：基于文件系统协调的主管模式                               │
└─────────────────────────────────────────────────────────────────┘
         │              │              │              │
         ▼              ▼              ▼              ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│   抓取者    │ │   分析者    │ │   撰写者    │ │   编辑      │
│   20k ctx   │ │   80k ctx   │ │   80k ctx   │ │   60k ctx   │
│ 针对每个账号│ 针对每个账号│ 针对每个章节│ 针对每个章节│
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
         │              │              │              │
         ▼              ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     文件系统存储                                │
│  raw_data/{account}/{date}.json                                  │
│  analysis/{account}/{date}.json                                  │
│  drafts/{book_id}/chapter_{n}.md                                 │
└─────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    时态知识图谱                                 │
│  实体: 账号, 推文, 主题, 书籍, 章节                              │
│  关系: POSTED, DISCUSSES, AGREES_WITH, SOURCES                   │
│  所有关系均具有时间有效期限                                     │
└─────────────────────────────────────────────────────────────────┘
```

## 演示的关键模式

| 模式 | 技能来源 | 应用 |
|---------|--------------|-------------|
| 通过子智能体实现上下文隔离 | multi-agent-patterns | 每个智能体拥有其阶段对应的干净上下文 |
| 文件系统作为协调机制 | multi-agent-patterns | 避免通过共享状态传递导致上下文膨胀 |
| 渐进式披露 | context-fundamentals | 仅在需要时加载章节内容 |
| 时态知识图谱 | memory-systems | 跟踪随时间演变的立场 |
| 观察遮蔽 | context-optimization | 原始推文从不进入编排者上下文 |
| 工具整合 | tool-design | 3 个工具取代 15+ 个 |
| 多维度评估 | evaluation | 5 个加权的质量维度 |

---

**创建日期**: 2025-12-25
**作者**: 上下文工程智能体技能贡献者
