# 技能映射：X-to-Book 系统

本文档提供了“上下文工程助手技能”与“X-to-Book 系统 PRD”中设计决策之间的详细映射。

## 技能：多智能体模式 (multi-agent-patterns)

### 应用的概念

| 概念 | 技能参考 | PRD 中的应用 |
|---------|-----------------|-----------------|
| 主管模式 (Supervisor pattern) | “主管模式赋予中央智能体控制权，负责分发给专家并汇总结果。” | 协调者智能体协调抓取器、分析器、综合器、撰写器和编辑器智能体 |
| 上下文隔离 (Context isolation) | “子智能体存在的主要目的是隔离上下文，而不是将角色划分拟人化。” | 每个智能体在专注于其阶段的纯净上下文中运行 |
| 信息失真问题 (Telephone game problem) | “LangGraph 基准测试发现主管架构最初的表现差了 50%，原因是‘信息失真’问题，即主管错误地转述了子智能体的响应。” | 阶段输出存储在文件系统中，撰写时不通过协调者进行综合 |
| 文件系统协调 | “对于需要共享状态的复杂任务，智能体对持久化存储进行读写。” | 所有智能体间的数据流都通过文件系统传输 |
| 缓解主管瓶颈 | “实施输出 Schema 约束，以便工作人员仅返回提炼后的摘要。” | 协调者接收阶段摘要，绝不接收原始数据 |

### 模式选择理由

技能描述了三种模式：

1. **主管/协调者 (Supervisor/Orchestrator)**：“使用场景：具有明确拆解的复杂任务，需要跨领域协调的任务。”
2. **点对点/群集 (Peer-to-Peer/Swarm)**：“使用场景：需要灵活探索的任务，僵化规划反而会适得其反的任务。”
3. **分层 (Hierarchical)**：“使用场景：具有明确层级结构的大规模项目。”

**已选择**：主管/协调者 (Supervisor/Orchestrator)

**理由**：书籍制作有明显的顺序阶段（抓取 → 分析 → 综合 → 撰写 → 编辑）。阶段之间的质量关卡需要中央协调。人工监督对于内容质量至关重要。

---

## 技能：上下文基础 (context-fundamentals)

### 应用的概念

| 概念 | 技能参考 | PRD 中的应用 |
|---------|-----------------|-----------------|
| 上下文作为有限资源 | “上下文必须被视为边际收益递减的有限资源。” | 为每个智能体设置明确的 token 预算（协调者 50k，撰写器 80k 等） |
| 渐进式披露 (Progressive disclosure) | “渐进式披露通过仅在需要时加载信息来高效管理上下文。” | 书籍大纲首先加载；只有当撰写器处理该章节时才加载章节内容 |
| 注意力预算 | “模型根据训练分布形成注意力模式，其中短序列占主导地位。” | 上下文限制设置保守，远低于模型的最大限制 |
| 工具输出量 | “在典型的智能体轨迹中，工具输出占据了大部分 token。研究表明观察值可达总上下文使用量的 83.9%。” | 推文数据单独处理，绝不进入主要智能体的上下文 |

### 上下文预算分配

源自技能：“设计时需考虑明确的上下文预算。了解您的模型和任务的有效上下文限制。”

PRD 实现：

```yaml
context_limits:
  orchestrator: 50000   # 仅路由，无原始数据
  scraper: 20000        # 一次一个账号
  analyzer: 80000       # 模式提取
  synthesizer: 100000   # 跨账号综合
  writer: 80000         # 按章节起草
  editor: 60000         # 按章节评审
```

---

## 技能：记忆系统 (memory-systems)

### 应用的概念

| 概念 | 技能参考 | PRD 中的应用 |
|---------|-----------------|-----------------|
| 向量库的局限性 | “向量库会丢失关系信息……无法回答‘购买了 Y 产品的客户还购买了哪些产品？’” | 选择知识图谱进行账号间的关系查询 |
| 时态有效性 (Temporal validity) | “时态知识图谱为事实添加了有效期。每个事实都有‘生效自’和可选的‘失效至’时间戳。” | 所有关系都具备时态有效性，用于跟踪立场的动态演变 |
| 实体记忆 | “实体记忆专门跟踪有关实体的信息以保持一致性。” | 定义了账号、推文、主题、书籍、章节等实体类型 |

### 记忆架构决策

源自技能：“根据需求选择记忆架构：简单的持久化需求 → 文件系统记忆；语义搜索需求 → 向量 RAG；关系推理需求 → 知识图谱；时态有效性需求 → 时态知识图谱。”

**确定的查询需求**：
- “@account 在过去 30 天内说了哪些关于 AI 的内容？” → 时态 + 实体过滤
- “哪些账号在加密货币上存在分歧？” → 关系遍历
- “@account 的立场是如何演变的？” → 时态查询

**已选择**：时态知识图谱 (Temporal Knowledge Graph)

---

## 技能：上下文优化 (context-optimization)

### 应用的概念

| 概念 | 技能参考 | PRD 中的应用 |
|---------|-----------------|-----------------|
| 观察掩码 (Observation masking) | “观察掩码用精简的引用替换冗长的工具输出。” | 原始推文数据存储在文件系统中，不通过上下文传递 |
| 压缩触发器 | “在内存大量积累、检索返回过多过时结果时触发压缩。” | 70% 的上下文利用率触发压缩 |
| KV-cache 优化 | “先放置稳定元素（系统提示词、工具定义），然后是频繁重用的元素，最后是独特的元素。” | 上下文排序：系统提示词 → 工具 → 账号配置 → 每日大纲 → 当前任务 |

### 优化策略

源自技能：“何时优化：上下文利用率超过 70%，响应质量随对话延长而下降。”

PRD 实现：
```python
COMPACTION_THRESHOLD = 0.7  # 70% 上下文利用率

if context_utilization > COMPACTION_THRESHOLD:
    phase_outputs = compact_phase_outputs(phase_outputs)
```

源自技能：“应应用什么：工具输出占主导地位 → 观察掩码”

PRD 实现：所有原始推文数据（潜在每天 10 万+ token）通过以下方式被掩蔽：
1. 抓取器写入文件系统
2. 分析器从文件系统读取，产出摘要
3. 摘要（而非原始数据）流向后续阶段

---

## 技能：工具设计 (tool-design)

### 应用的概念

| 概念 | 技能参考 | PRD 中的应用 |
|---------|-----------------|-----------------|
| 整合原则 (Consolidation principle) | “如果人类工程师无法明确说明在特定情况下应该使用哪个工具，那么就不能指望助手能做得更好。” | 使用 3 个整合工具代替 15+ 个狭窄工具 |
| 描述结构 | “有效的工具描述回答四个问题：工具做什么？何时用？接受什么输入？返回什么？” | 所有工具都有明确的触发条件和错误恢复机制 |
| 响应格式选项 | “实现响应格式选项可让智能体控制详细程度。” | 工具支持 "concise"（简明）和 "detailed"（详细）格式参数 |
| 错误消息设计 | “错误消息必须是可操作的。它们必须告诉助手哪里出错以及如何纠正。” | 错误包含恢复指导（RATE_LIMITED 包含 retry_after） |

### 工具整合

源自技能：“与其实现 `list_users`、`list_events` 和 `create_event`，不如实现负责处理完整内部工作流的 `schedule_event`。”

PRD 实现：

**整合前**（我们避免的做法）：
- `fetch_timeline`
- `fetch_thread`
- `fetch_engagement`
- `search_tweets`
- `store_entity`
- `query_entities`
- `update_validity`
- 等等。

**整合后**：
- `x_data_tool` - 所有 X 数据操作
- `memory_tool` - 所有知识图谱操作
- `writing_tool` - 所有内容操作

---

## 技能：评估 (evaluation)

### 应用的概念

| 概念 | 技能参考 | PRD 中的应用 |
|---------|-----------------|-----------------|
| 多维评分标准 (Multi-dimensional rubrics) | “智能体质量并非单一维度。它包含事实准确性、完整性、连贯性、工具效率和过程质量。” | 5 个加权维度：来源准确性、主题连贯性、完整性、见解质量、可读性 |
| LLM 即评委 (LLM-as-judge) | “基于 LLM 的评估可扩展到大型测试集，并提供一致的判定。” | 对连贯性和见解质量进行自动化评估 |
| 人工评估 | “人工评估捕捉自动化遗漏的内容。” | 当分数 < 0.7 或来源准确性 < 0.8 时触发人工审核 |
| 以结果为中心的评估 | “解决方案是以结果为中心的评估，判断智能体是否在遵循合理过程的同时实现了正确的结果。” | 评估最终书籍质量，而非中间步骤 |

### 评估评分标准

源自技能：“有效的评分标准涵盖关键维度并具有描述性等级。”

PRD 实现：

| 维度 | 权重 | 测量方法 |
|-----------|--------|-------------|
| 来源准确性 | 30% | 根据原始推文进行自动化引用验证 |
| 主题连贯性 | 25% | LLM 即评委评估叙事流 |
| 完整性 | 20% | 主题覆盖率计算 |
| 见解质量 | 15% | LLM 即评委评估超越陈述事实的综合能力 |
| 可读性 | 10% | 自动化指标 + LLM 评委 |

---

## 跨技能集成

这些技能旨在协同工作。本示例演示了集成模式：

| 集成项 | 技能组合 | 应用 |
|-------------|-----------------|-------------|
| 智能体上下文预算 | 多智能体模式 + 上下文基础 | 每个智能体根据角色拥有明确的限制 |
| 文件系统协调 | 多智能体模式 + 上下文优化 | 避免上下文传递，实现掩码机制 |
| 具记忆意识的综合 | 记忆系统 + 上下文优化 | 在不加载完整历史记录的情况下查询相关事实 |
| 质量驱动的路由 | 评估 + 多智能体模式 | 协调者使用质量分作为阶段性关卡 |

这种集成是此技能集合的核心价值主张：它们提供的补充模式解决了上下文工程的不同方面，同时能凝聚在一起共同发挥作用。
